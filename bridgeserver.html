<!DOCTYPE html>
<html>
<head>
  <script type="text/javascript" src=" http://getbridge.com/js/bridge.min.js"></script>
</head>

<body>
<script>

var bridge = new Bridge({apiKey: 'f99ede2465de4114'});

var messageCb = function(msg) {console.log(msg)}

var vals = []
var messageCb1 = function(msg) {
  vals.push(msg)
      var total = 0;
      for(var i in vals) {
        total += vals[i];
      }
      document.write(4*total/1000000000 + "<br>") 
}
/*
var forCluster = " \
handler.run  =  function(message_cb, start, end) { \
        var temp = start + end; \
        console.log(temp); \
        message_cb(temp); \
} " */

var piforcluster = " handler.run = function calc_pi(message_cb) { starttime = new Date(); console.log('running task '+ starttime.getTime()); var hits = 0; var trials = Math.floor(1000000000/1); for(i = 0; i < trials; i++) {var x = Math.random(); var y = Math.random(); if(x*x + y*y <= 1.0){ hits++; } }endtime = new Date(); console.log('finished task '+ (endtime.getTime() - starttime.getTime())); message_cb(hits); }"


bridge.getChannel('function-channel', function(channel){
   channel.message(piforcluster);
});

var counter = 0;

var functionExecutor = {
  message: function(msg) {
    counter++;
    console.log(counter);
    if (counter == 1) {
      for(var i=0; i<1; i++) {

        bridge.getService('cluster', function(clusterService, name) {
          clusterService.run(messageCb1);
        });
        
      }
   /* 
      bridge.getService('cluster', function(clusterService, name) {
        clusterService.run(messageCb, 4, 5);
      });

      bridge.getService('cluster', function(clusterService, name) {
        clusterService.run(messageCb, 6, 5);
      });
   */
    }
  }
}

bridge.joinChannel('ack-channel', functionExecutor)
bridge.connect();
</script>
</body>
</html> 
